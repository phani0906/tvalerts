<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trading Scanner</title>
    <link rel="stylesheet" href="scanner.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <h2>Trading View Scanner</h2>
    <table id="scannerTable">
        <thead>
            <tr>
                <th>Time</th>
                <th>Ticker</th>
                <th>Pivot Rel.</th>
                <th>Trend</th>
                <th>Price</th>
                <th>DayMid</th>
                <th>WeeklyMid</th>
                <th>MA20</th>
                <th>NCPR</th>
                <th>Pivot</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
        const socket = io();

        function getPivotRelColor(value) {
            switch(value) {
                case "HV": case "OHV": return "green";
                case "LV": case "OLV": return "red";
                case "IV": return "blue";
                case "OV": case "NC": return "gray";
                default: return "white";
            }
        }

        function getTrendArrow(value) {
            if(!value) return "No value";
            value = value.toLowerCase();
            if(value.includes("bullish")) return {arrow:"↗", className:"trend-bull"};
            if(value.includes("bearish")) return {arrow:"↘", className:"trend-bear"};
            return {arrow:"→", className:""}; // neutral
        }

        socket.on('newAlert', (alerts) => {
            const tbody = document.querySelector("#scannerTable tbody");
            tbody.innerHTML = ""; // clear old rows

            alerts.forEach(data => {
                const tr = document.createElement("tr");

                const timeTd = document.createElement("td");
                timeTd.textContent = data.timestamp || "No value";

                const tickerTd = document.createElement("td");
                tickerTd.textContent = data.Ticker || "No value";

                const pivotTd = document.createElement("td");
                pivotTd.textContent = data.Rel || "No value";
                pivotTd.style.color = getPivotRelColor(data.Rel);
                pivotTd.style.fontWeight = "bold";

                const trendTd = document.createElement("td");
                const trendInfo = getTrendArrow(data.Trend);
                trendTd.textContent = trendInfo.arrow;
                trendTd.className = "trend-arrow " + trendInfo.className;

                const priceTd = document.createElement("td");
                priceTd.textContent = data.Price || "No value";

                const dayMidTd = document.createElement("td");
                dayMidTd.textContent = data.DayMid || "No value";

                const weeklyMidTd = document.createElement("td");
                weeklyMidTd.textContent = data.WeeklyMid || "No value";

                const ma20Td = document.createElement("td");
                ma20Td.textContent = data.MA20 || "No value";

                const ncprTd = document.createElement("td");
                ncprTd.textContent = data.NCPR || "No value";

                const pivotCalcTd = document.createElement("td");
                pivotCalcTd.textContent = data.Pivot || "No value";

                tr.append(timeTd, tickerTd, pivotTd, trendTd, priceTd, dayMidTd, weeklyMidTd, ma20Td, ncprTd, pivotCalcTd);
                tbody.appendChild(tr);
            });
        });
    </script>
</body>
</html>
